ARG python_version=3.8
ARG image=python:${python_version}-slim

FROM ${image} as lock-stage
WORKDIR /app
COPY . .
RUN [ -f Pipfile.lock -o -f Pipfile ] && pip install pipenv && pipenv lock --requirements > requirements.txt
RUN cat requirements.txt

FROM ${image}
RUN apt update && apt install -y git build-essential
WORKDIR /app
COPY . .
COPY --from=lock-stage /app/requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
